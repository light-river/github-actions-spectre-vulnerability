# Copyright (C) 2021 light-river, LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

CC = go
CFLAGS = build -o
OUT_DIR = .overlay/.env
PROJ_NAME = Kota
TEST_FS = ubuntu-20.10-rootfs.tar.xz
SHELL = /bin/bash

build: clean deps test build-local
end-to-end: build pull enter
all: build run
enter: build enter
break: build invalid-cmd
help: build help
release: build compress

deps:
	$(CC) get ./... && $(CC) mod tidy
	go get -u github.com/golang/protobuf/protoc-gen-go@v1.3.2
	go get -u github.com/light-river/core@latest

build-local:
	$(CC) $(CFLAGS) $(PROJ_NAME) 

help:
	$(PROJ_NAME) -h

test:
	$(CC) test -v ./...

compress:
	tar --zstd -cf $(PROJ_NAME).tar.zst $(PROJ_NAME)

pull:
	./$(PROJ_NAME) -k pull

run:
	./$(PROJ_NAME) -k run -c echo -a hello

enter:
	./$(PROJ_NAME) -k run -c bash
	
invalid-cmd:
	./$(PROJ_NAME) INVALID_CMD echo hello

clean:
	$(RM) $(OUT_DIR)/$(PROJ_NAME) && $(RM) $(OUT_DIR)/$(PROJ_NAME).tar.* && $(RM) $(PROJ_NAME).tar.*

.PHONY: deps, build, test, compress, run, clean, all, release, dry-run, enter, build-local, pull
